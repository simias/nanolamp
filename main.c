#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/sleep.h>
#include <util/delay.h>
#include <stdbool.h>
#include <stdio.h>

#define ARRAY_SIZE(_arr) (sizeof(_arr) / sizeof((_arr)[0]))

#define BAUD_RATE 9600UL
#define USART_BAUD_RATE(_br) ((F_CPU * 4 + (_br) / 2) / (_br))

struct led_color {
    uint8_t r;
    uint8_t g;
    uint8_t b;
};

#define NLEDS 28U

static struct led_color leds[NLEDS] = { { 0 }};

/* LED color as sent on the SPI. We need 6 bits per color bit */
static uint8_t led_spi_encoded[NLEDS * 3 * 6];

static void led_spi_set_bit(uint16_t bitpos, uint8_t b) {
    uint16_t byte = bitpos >> 3;
    unsigned shift = bitpos & 7;

    b = !!b;

    led_spi_encoded[byte] |= b << shift;
}

static void spi_init(void) {
    PORTMUX.TWISPIROUTEA &= ~PORTMUX_SPI0_gm;
    PORTMUX.TWISPIROUTEA |= PORTMUX_SPI0_1_bm;

    /* Set MOSI pin direction to output */
    PORTE.DIR |= PIN0_bm;

    /* Set Clock as an output (this is also the built-in LED) */
    PORTE.DIR |= PIN2_bm;


    SPI0.CTRLA = SPI_DORD_bm            /* LSB is transmitted first */
               | SPI_ENABLE_bm          /* Enable module */
               | SPI_MASTER_bm          /* SPI module in Master mode */
               | SPI_PRESC_DIV4_gc;     /* System Clock divided by 4 */

    /* Enable double buffering and MODE0 */
    SPI0.CTRLB = SPI_BUFEN_bm | SPI_MODE_0_bm;
}

static void spi_send_encoded() {
    /* We need at least 50us of zero to reset */
    for (unsigned i = 0; i < 15; i++) {
        while (!(SPI0.INTFLAGS & SPI_DREIF_bm)) {};
        SPI0.DATA = 0;
    }

    for (unsigned i = 0; i < ARRAY_SIZE(led_spi_encoded); i++) {
        /* Wait for data register empty */
        while (!(SPI0.INTFLAGS & SPI_DREIF_bm)) {};
        /* SPI0.DATA = led_spi_encoded[i] | 0xff; */
        SPI0.DATA = led_spi_encoded[i];
    }
}

static void spi_send_leds() {
    /* We need to output the LEDs very fast and without interruption since the
     * protocol uses fixed timings to detect ones and zeroes (it's not real
     * SPI). This chip is not fast enough to do both the encoding and sending at
     * the same time without breaks between bytes, so we need to precompute
     * everything. */
    uint16_t bitpos = 0;

    for (unsigned i = 0; i < ARRAY_SIZE(led_spi_encoded); i++) {
        led_spi_encoded[i] = 0x00;
    }

    for (unsigned led = 0; led < NLEDS; led++) {
        uint32_t c = 0;
        c |= leds[led].g;
        c <<= 8;
        c |= leds[led].r;
        c <<= 8;
        c |= leds[led].b;

        for (unsigned b = 0; b < 24; b++) {
            unsigned high = (c >> (23 - b)) & 1;

            /* It's hard to get clean timing with the Atmel because the SPI
             * tends to insert small pauses between bytes which mess the timings
             * up. Theoretically we could do with only 3 bit per LED bit: 100 or
             * 110, but it doesn't work well in my experiments.
             *
             * Instead I double the SPI clock and do this: 100000 for 0, 111100
             * for 1. That means that the 0 pulses are a bit below spec */
            led_spi_set_bit(bitpos++, 1);
            led_spi_set_bit(bitpos++, high);
            led_spi_set_bit(bitpos++, high);
            led_spi_set_bit(bitpos++, high);
            led_spi_set_bit(bitpos++, 0);
            led_spi_set_bit(bitpos++, 0);
        }
    }

    spi_send_encoded();
}

static int uart_putchar(int c) {
    while (!(USART3.STATUS & USART_DREIF_bm)) {
        ;
    }

    USART3.TXDATAL = c;

    return c;
}

static int uart_putchar_stream(char c, FILE *stream) {
    if (c == '\n') {
        uart_putchar('\r');
    }

    return uart_putchar(c);
}

static FILE uart_stream = FDEV_SETUP_STREAM(uart_putchar_stream, NULL, _FDEV_SETUP_WRITE);

static void uart_init(void) {
    USART3.BAUD = USART_BAUD_RATE(BAUD_RATE);
    USART3.CTRLB = USART_TXEN_bm;

    /* Sent USART 3 on PB[5:4] */
    PORTMUX.USARTROUTEA |= PORTMUX_USART3_ALT1_gc;

    /* PIN 4 TX*/
    PORTB.DIR |= PIN4_bm;

    stdout = &uart_stream;
}


static void adc_init(void)
{
    /* PD5 input*/
    /* PORTD.DIR &= ~PIN5_bm; */

    /* Disable digital input buffer */
    PORTD.PIN5CTRL &= ~PORT_ISC_gm;
    PORTD.PIN5CTRL |= PORT_ISC_INPUT_DISABLE_gc;

    /* Disable pull-up resistor */
    PORTD.PIN5CTRL &= ~PORT_PULLUPEN_bm;

    /* Clock divider must be selected so that we don't overclock the ADC. In
     * 10bits according the the datasheet the freq should be between 200 and
     * 1500kHz (200 - 2000kHz in 8bits)
     */
    ADC0.CTRLC = ADC_PRESC_DIV64_gc
               | ADC_REFSEL_VDDREF_gc;

    ADC0.CTRLA = ADC_ENABLE_bm          /* ADC Enable: enabled */
               | ADC_RESSEL_10BIT_gc;   /* 10-bit mode */

    /* Acculumate 64 samples because why not */
    ADC0.CTRLB = ADC_SAMPNUM_ACC64_gc;

}

static uint16_t adc_read(uint8_t adc_muxpos) {
    /* Select ADC channel */
    ADC0.MUXPOS = adc_muxpos;

    ADC0.COMMAND = ADC_STCONV_bm;

    while (!(ADC0.INTFLAGS & ADC_RESRDY_bm)) {
        ;
    }
    ADC0.INTFLAGS = ADC_RESRDY_bm;

    /* Divide by 64 since we accumulate 64 samples */
    return ADC0.RES >> 6;
}

#if 0
/* 2.2 Gamma LUT */
static const uint8_t log_lut[256] = {
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   1,   1,   1,   1,   1,   1,   1,   1,   2,   2,   2,
      2,   2,   3,   3,   3,   3,   3,   4,   4,   4,   4,   5,   5,   5,   5,   6,
      6,   6,   7,   7,   7,   8,   8,   8,   9,   9,   9,  10,  10,  10,  11,  11,
     12,  12,  13,  13,  13,  14,  14,  15,  15,  16,  16,  17,  17,  18,  18,  19,
     19,  20,  21,  21,  22,  22,  23,  23,  24,  25,  25,  26,  27,  27,  28,  29,
     29,  30,  31,  31,  32,  33,  33,  34,  35,  36,  36,  37,  38,  39,  40,  40,
     41,  42,  43,  44,  45,  45,  46,  47,  48,  49,  50,  51,  52,  53,  54,  55,
     55,  56,  57,  58,  59,  60,  61,  62,  63,  65,  66,  67,  68,  69,  70,  71,
     72,  73,  74,  75,  77,  78,  79,  80,  81,  82,  84,  85,  86,  87,  88,  90,
     91,  92,  93,  95,  96,  97,  99, 100, 101, 103, 104, 105, 107, 108, 109, 111,
    112, 114, 115, 117, 118, 119, 121, 122, 124, 125, 127, 128, 130, 131, 133, 135,
    136, 138, 139, 141, 142, 144, 146, 147, 149, 151, 152, 154, 156, 157, 159, 161,
    162, 164, 166, 168, 169, 171, 173, 175, 176, 178, 180, 182, 184, 186, 187, 189,
    191, 193, 195, 197, 199, 201, 203, 205, 207, 209, 211, 213, 215, 217, 219, 221,
    223, 225, 227, 229, 231, 233, 235, 237, 239, 241, 244, 246, 248, 250, 252, 255,
};
#endif

#if 0
/* 2.3 Gamma LUT + 10-to-8 bit conversion*/
uint8_t log_lut[1024] = {
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   1,   1,   1,   1,
      1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,
      1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   1,   2,   2,   2,
      2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,   2,
      2,   2,   2,   2,   2,   3,   3,   3,   3,   3,   3,   3,   3,   3,   3,   3,
      3,   3,   3,   3,   3,   3,   3,   3,   3,   4,   4,   4,   4,   4,   4,   4,
      4,   4,   4,   4,   4,   4,   4,   4,   4,   4,   5,   5,   5,   5,   5,   5,
      5,   5,   5,   5,   5,   5,   5,   5,   5,   6,   6,   6,   6,   6,   6,   6,
      6,   6,   6,   6,   6,   6,   6,   7,   7,   7,   7,   7,   7,   7,   7,   7,
      7,   7,   7,   7,   8,   8,   8,   8,   8,   8,   8,   8,   8,   8,   8,   8,
      9,   9,   9,   9,   9,   9,   9,   9,   9,   9,   9,  10,  10,  10,  10,  10,
     10,  10,  10,  10,  10,  11,  11,  11,  11,  11,  11,  11,  11,  11,  11,  12,
     12,  12,  12,  12,  12,  12,  12,  12,  12,  13,  13,  13,  13,  13,  13,  13,
     13,  13,  14,  14,  14,  14,  14,  14,  14,  14,  14,  15,  15,  15,  15,  15,
     15,  15,  15,  16,  16,  16,  16,  16,  16,  16,  16,  16,  17,  17,  17,  17,
     17,  17,  17,  17,  18,  18,  18,  18,  18,  18,  18,  19,  19,  19,  19,  19,
     19,  19,  19,  20,  20,  20,  20,  20,  20,  20,  21,  21,  21,  21,  21,  21,
     21,  22,  22,  22,  22,  22,  22,  22,  23,  23,  23,  23,  23,  23,  23,  24,
     24,  24,  24,  24,  24,  25,  25,  25,  25,  25,  25,  25,  26,  26,  26,  26,
     26,  26,  27,  27,  27,  27,  27,  27,  28,  28,  28,  28,  28,  28,  29,  29,
     29,  29,  29,  29,  30,  30,  30,  30,  30,  30,  31,  31,  31,  31,  31,  32,
     32,  32,  32,  32,  32,  33,  33,  33,  33,  33,  33,  34,  34,  34,  34,  34,
     35,  35,  35,  35,  35,  36,  36,  36,  36,  36,  37,  37,  37,  37,  37,  37,
     38,  38,  38,  38,  38,  39,  39,  39,  39,  39,  40,  40,  40,  40,  40,  41,
     41,  41,  41,  42,  42,  42,  42,  42,  43,  43,  43,  43,  43,  44,  44,  44,
     44,  44,  45,  45,  45,  45,  46,  46,  46,  46,  46,  47,  47,  47,  47,  48,
     48,  48,  48,  48,  49,  49,  49,  49,  50,  50,  50,  50,  50,  51,  51,  51,
     51,  52,  52,  52,  52,  53,  53,  53,  53,  54,  54,  54,  54,  54,  55,  55,
     55,  55,  56,  56,  56,  56,  57,  57,  57,  57,  58,  58,  58,  58,  59,  59,
     59,  59,  60,  60,  60,  60,  61,  61,  61,  61,  62,  62,  62,  62,  63,  63,
     63,  64,  64,  64,  64,  65,  65,  65,  65,  66,  66,  66,  66,  67,  67,  67,
     68,  68,  68,  68,  69,  69,  69,  69,  70,  70,  70,  71,  71,  71,  71,  72,
     72,  72,  73,  73,  73,  73,  74,  74,  74,  75,  75,  75,  75,  76,  76,  76,
     77,  77,  77,  77,  78,  78,  78,  79,  79,  79,  80,  80,  80,  80,  81,  81,
     81,  82,  82,  82,  83,  83,  83,  83,  84,  84,  84,  85,  85,  85,  86,  86,
     86,  87,  87,  87,  87,  88,  88,  88,  89,  89,  89,  90,  90,  90,  91,  91,
     91,  92,  92,  92,  93,  93,  93,  94,  94,  94,  95,  95,  95,  96,  96,  96,
     97,  97,  97,  97,  98,  98,  99,  99,  99, 100, 100, 100, 101, 101, 101, 102,
    102, 102, 103, 103, 103, 104, 104, 104, 105, 105, 105, 106, 106, 106, 107, 107,
    107, 108, 108, 109, 109, 109, 110, 110, 110, 111, 111, 111, 112, 112, 112, 113,
    113, 114, 114, 114, 115, 115, 115, 116, 116, 116, 117, 117, 118, 118, 118, 119,
    119, 119, 120, 120, 121, 121, 121, 122, 122, 122, 123, 123, 124, 124, 124, 125,
    125, 126, 126, 126, 127, 127, 127, 128, 128, 129, 129, 129, 130, 130, 131, 131,
    131, 132, 132, 133, 133, 133, 134, 134, 135, 135, 135, 136, 136, 137, 137, 137,
    138, 138, 139, 139, 139, 140, 140, 141, 141, 141, 142, 142, 143, 143, 144, 144,
    144, 145, 145, 146, 146, 146, 147, 147, 148, 148, 149, 149, 149, 150, 150, 151,
    151, 152, 152, 152, 153, 153, 154, 154, 155, 155, 155, 156, 156, 157, 157, 158,
    158, 158, 159, 159, 160, 160, 161, 161, 162, 162, 162, 163, 163, 164, 164, 165,
    165, 166, 166, 166, 167, 167, 168, 168, 169, 169, 170, 170, 171, 171, 171, 172,
    172, 173, 173, 174, 174, 175, 175, 176, 176, 177, 177, 178, 178, 178, 179, 179,
    180, 180, 181, 181, 182, 182, 183, 183, 184, 184, 185, 185, 186, 186, 187, 187,
    187, 188, 188, 189, 189, 190, 190, 191, 191, 192, 192, 193, 193, 194, 194, 195,
    195, 196, 196, 197, 197, 198, 198, 199, 199, 200, 200, 201, 201, 202, 202, 203,
    203, 204, 204, 205, 205, 206, 206, 207, 207, 208, 208, 209, 209, 210, 210, 211,
    211, 212, 212, 213, 214, 214, 215, 215, 216, 216, 217, 217, 218, 218, 219, 219,
    220, 220, 221, 221, 222, 222, 223, 224, 224, 225, 225, 226, 226, 227, 227, 228,
    228, 229, 229, 230, 231, 231, 232, 232, 233, 233, 234, 234, 235, 235, 236, 237,
    237, 238, 238, 239, 239, 240, 240, 241, 242, 242, 243, 243, 244, 244, 245, 245,
    246, 247, 247, 248, 248, 249, 249, 250, 251, 251, 252, 252, 253, 253, 254, 255,
};
#endif

#if 0
/* 2.3 gamma */
uint8_t log_lut[256] = {
      0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   0,   1,   1,   1,   1,   1,   1,   1,   1,   2,
      2,   2,   2,   2,   2,   3,   3,   3,   3,   3,   4,   4,   4,   4,   4,   5,
      5,   5,   6,   6,   6,   6,   7,   7,   7,   8,   8,   8,   9,   9,   9,  10,
     10,  10,  11,  11,  12,  12,  13,  13,  13,  14,  14,  15,  15,  16,  16,  17,
     17,  18,  18,  19,  19,  20,  20,  21,  22,  22,  23,  23,  24,  25,  25,  26,
     26,  27,  28,  28,  29,  30,  30,  31,  32,  33,  33,  34,  35,  36,  36,  37,
     38,  39,  40,  40,  41,  42,  43,  44,  45,  45,  46,  47,  48,  49,  50,  51,
     52,  53,  54,  55,  56,  57,  58,  59,  60,  61,  62,  63,  64,  65,  66,  67,
     68,  69,  70,  71,  72,  74,  75,  76,  77,  78,  79,  81,  82,  83,  84,  86,
     87,  88,  89,  91,  92,  93,  95,  96,  97,  99, 100, 101, 103, 104, 105, 107,
    108, 110, 111, 112, 114, 115, 117, 118, 120, 121, 123, 124, 126, 128, 129, 131,
    132, 134, 135, 137, 139, 140, 142, 144, 145, 147, 149, 150, 152, 154, 156, 157,
    159, 161, 163, 164, 166, 168, 170, 172, 174, 175, 177, 179, 181, 183, 185, 187,
    189, 191, 193, 195, 197, 199, 201, 203, 205, 207, 209, 211, 213, 215, 217, 219,
    221, 223, 226, 228, 230, 232, 234, 236, 239, 241, 243, 245, 248, 250, 252, 255,
};
#endif

#if 0
/* 2.0 gamma */
uint16_t log_lut[256] = {
       0,    0,    0,    0,    0,    0,    0,    0,    1,    1,    1,    1,    2,    2,    3,    3,
       4,    4,    5,    5,    6,    6,    7,    8,    9,    9,   10,   11,   12,   13,   14,   15,
      16,   17,   18,   19,   20,   21,   22,   23,   25,   26,   27,   29,   30,   31,   33,   34,
      36,   37,   39,   40,   42,   44,   45,   47,   49,   51,   52,   54,   56,   58,   60,   62,
      64,   66,   68,   70,   72,   74,   77,   79,   81,   83,   86,   88,   90,   93,   95,   98,
     100,  103,  105,  108,  111,  113,  116,  119,  121,  124,  127,  130,  133,  136,  139,  142,
     145,  148,  151,  154,  157,  160,  163,  167,  170,  173,  176,  180,  183,  187,  190,  194,
     197,  201,  204,  208,  211,  215,  219,  223,  226,  230,  234,  238,  242,  246,  250,  253,
     258,  262,  266,  270,  274,  278,  282,  287,  291,  295,  299,  304,  308,  313,  317,  322,
     326,  331,  335,  340,  344,  349,  354,  359,  363,  368,  373,  378,  383,  388,  393,  398,
     403,  408,  413,  418,  423,  428,  433,  439,  444,  449,  455,  460,  465,  471,  476,  482,
     487,  493,  498,  504,  510,  515,  521,  527,  533,  538,  544,  550,  556,  562,  568,  574,
     580,  586,  592,  598,  604,  611,  617,  623,  629,  636,  642,  648,  655,  661,  668,  674,
     681,  687,  694,  701,  707,  714,  721,  727,  734,  741,  748,  755,  762,  769,  776,  783,
     790,  797,  804,  811,  818,  825,  833,  840,  847,  854,  862,  869,  877,  884,  892,  899,
     907,  914,  922,  929,  937,  945,  952,  960,  968,  976,  984,  992, 1000, 1008, 1015, 1024,
};
#endif

/* 2.0 gamma */
uint16_t log_lut[1024] = {
       0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
       0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,
       1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    1,    2,    2,
       2,    2,    2,    2,    2,    2,    2,    2,    3,    3,    3,    3,    3,    3,    3,    3,
       4,    4,    4,    4,    4,    4,    4,    4,    5,    5,    5,    5,    5,    5,    5,    6,
       6,    6,    6,    6,    6,    7,    7,    7,    7,    7,    7,    8,    8,    8,    8,    8,
       9,    9,    9,    9,    9,    9,   10,   10,   10,   10,   10,   11,   11,   11,   11,   12,
      12,   12,   12,   12,   13,   13,   13,   13,   14,   14,   14,   14,   15,   15,   15,   15,
      16,   16,   16,   16,   17,   17,   17,   17,   18,   18,   18,   18,   19,   19,   19,   19,
      20,   20,   20,   21,   21,   21,   21,   22,   22,   22,   23,   23,   23,   24,   24,   24,
      25,   25,   25,   25,   26,   26,   26,   27,   27,   27,   28,   28,   28,   29,   29,   29,
      30,   30,   30,   31,   31,   32,   32,   32,   33,   33,   33,   34,   34,   34,   35,   35,
      36,   36,   36,   37,   37,   37,   38,   38,   39,   39,   39,   40,   40,   41,   41,   41,
      42,   42,   43,   43,   43,   44,   44,   45,   45,   46,   46,   46,   47,   47,   48,   48,
      49,   49,   49,   50,   50,   51,   51,   52,   52,   53,   53,   53,   54,   54,   55,   55,
      56,   56,   57,   57,   58,   58,   59,   59,   60,   60,   61,   61,   62,   62,   63,   63,
      64,   64,   65,   65,   66,   66,   67,   67,   68,   68,   69,   69,   70,   70,   71,   71,
      72,   72,   73,   73,   74,   75,   75,   76,   76,   77,   77,   78,   78,   79,   79,   80,
      81,   81,   82,   82,   83,   83,   84,   85,   85,   86,   86,   87,   87,   88,   89,   89,
      90,   90,   91,   92,   92,   93,   93,   94,   95,   95,   96,   96,   97,   98,   98,   99,
     100,  100,  101,  101,  102,  103,  103,  104,  105,  105,  106,  107,  107,  108,  109,  109,
     110,  111,  111,  112,  113,  113,  114,  115,  115,  116,  117,  117,  118,  119,  119,  120,
     121,  121,  122,  123,  123,  124,  125,  125,  126,  127,  128,  128,  129,  130,  130,  131,
     132,  133,  133,  134,  135,  136,  136,  137,  138,  138,  139,  140,  141,  141,  142,  143,
     144,  144,  145,  146,  147,  147,  148,  149,  150,  150,  151,  152,  153,  154,  154,  155,
     156,  157,  157,  158,  159,  160,  161,  161,  162,  163,  164,  165,  165,  166,  167,  168,
     169,  169,  170,  171,  172,  173,  174,  174,  175,  176,  177,  178,  179,  179,  180,  181,
     182,  183,  184,  184,  185,  186,  187,  188,  189,  190,  190,  191,  192,  193,  194,  195,
     196,  197,  197,  198,  199,  200,  201,  202,  203,  204,  205,  205,  206,  207,  208,  209,
     210,  211,  212,  213,  214,  215,  215,  216,  217,  218,  219,  220,  221,  222,  223,  224,
     225,  226,  227,  228,  228,  229,  230,  231,  232,  233,  234,  235,  236,  237,  238,  239,
     240,  241,  242,  243,  244,  245,  246,  247,  248,  249,  250,  251,  252,  253,  254,  255,
     256,  257,  258,  259,  260,  261,  262,  263,  264,  265,  266,  267,  268,  269,  270,  271,
     272,  273,  274,  275,  276,  277,  278,  279,  280,  281,  282,  283,  285,  286,  287,  288,
     289,  290,  291,  292,  293,  294,  295,  296,  297,  298,  300,  301,  302,  303,  304,  305,
     306,  307,  308,  309,  310,  312,  313,  314,  315,  316,  317,  318,  319,  320,  322,  323,
     324,  325,  326,  327,  328,  329,  331,  332,  333,  334,  335,  336,  337,  339,  340,  341,
     342,  343,  344,  346,  347,  348,  349,  350,  351,  353,  354,  355,  356,  357,  358,  360,
     361,  362,  363,  364,  366,  367,  368,  369,  370,  372,  373,  374,  375,  376,  378,  379,
     380,  381,  383,  384,  385,  386,  387,  389,  390,  391,  392,  394,  395,  396,  397,  399,
     400,  401,  402,  404,  405,  406,  407,  409,  410,  411,  413,  414,  415,  416,  418,  419,
     420,  421,  423,  424,  425,  427,  428,  429,  430,  432,  433,  434,  436,  437,  438,  440,
     441,  442,  444,  445,  446,  448,  449,  450,  452,  453,  454,  456,  457,  458,  460,  461,
     462,  464,  465,  466,  468,  469,  470,  472,  473,  474,  476,  477,  478,  480,  481,  483,
     484,  485,  487,  488,  489,  491,  492,  494,  495,  496,  498,  499,  501,  502,  503,  505,
     506,  508,  509,  510,  512,  513,  515,  516,  518,  519,  520,  522,  523,  525,  526,  528,
     529,  530,  532,  533,  535,  536,  538,  539,  541,  542,  544,  545,  546,  548,  549,  551,
     552,  554,  555,  557,  558,  560,  561,  563,  564,  566,  567,  569,  570,  572,  573,  575,
     576,  578,  579,  581,  582,  584,  585,  587,  588,  590,  591,  593,  594,  596,  597,  599,
     600,  602,  603,  605,  606,  608,  610,  611,  613,  614,  616,  617,  619,  620,  622,  624,
     625,  627,  628,  630,  631,  633,  635,  636,  638,  639,  641,  642,  644,  646,  647,  649,
     650,  652,  654,  655,  657,  658,  660,  662,  663,  665,  666,  668,  670,  671,  673,  675,
     676,  678,  679,  681,  683,  684,  686,  688,  689,  691,  693,  694,  696,  697,  699,  701,
     702,  704,  706,  707,  709,  711,  712,  714,  716,  717,  719,  721,  722,  724,  726,  728,
     729,  731,  733,  734,  736,  738,  739,  741,  743,  744,  746,  748,  750,  751,  753,  755,
     756,  758,  760,  762,  763,  765,  767,  769,  770,  772,  774,  776,  777,  779,  781,  783,
     784,  786,  788,  790,  791,  793,  795,  797,  798,  800,  802,  804,  805,  807,  809,  811,
     813,  814,  816,  818,  820,  821,  823,  825,  827,  829,  830,  832,  834,  836,  838,  840,
     841,  843,  845,  847,  849,  850,  852,  854,  856,  858,  860,  861,  863,  865,  867,  869,
     871,  872,  874,  876,  878,  880,  882,  884,  885,  887,  889,  891,  893,  895,  897,  899,
     900,  902,  904,  906,  908,  910,  912,  914,  915,  917,  919,  921,  923,  925,  927,  929,
     931,  933,  934,  936,  938,  940,  942,  944,  946,  948,  950,  952,  954,  956,  958,  960,
     961,  963,  965,  967,  969,  971,  973,  975,  977,  979,  981,  983,  985,  987,  989,  991,
     993,  995,  997,  999, 1001, 1003, 1005, 1007, 1009, 1011, 1013, 1015, 1017, 1019, 1021, 1023,
};

static const struct led_color led_stops[] = {
    {
        .r = 255,
        .g = 255,
        .b = 255,
    },
    {
        .r = 0,
        .g = 0,
        .b = 255,
    },
    {
        .r = 0,
        .g = 255,
        .b = 0,
    },
    {
        .r = 255,
        .g = 255,
        .b = 0,
    },
    {
        .r = 255,
        .g = 0,
        .b = 0,
    },
    {
        .r = 253,
        .g = 150,
        .b = 64,
    },
};

int main(void) {
    uint16_t cur_intensity = (uint16_t) -1;
    uint16_t cur_hue = (uint16_t) -1;

    cli();

    /* Disable divider to run at full 20MHz, otherwise the default value is
     * 0b1001 which is equal to /6 or 3.333MHz.
     * https://onlinedocs.microchip.com/oxy/GUID-8109B192-2AF1-4902-BA7D-C3C6DA7BDC69-en-US-3/GUID-205EC738-D303-46E3-AAD4-5F1FB6C357A1.html */
    _PROTECTED_WRITE(CLKCTRL_MCLKCTRLB, 0x00);

    uart_init();
    puts("Starting up...");

    adc_init();

    spi_init();
    spi_send_leds();

    for (;;) {
        /* We get a value in the range 0;1023 that we downscale to 8bit */
        uint16_t intensity = adc_read(ADC_MUXPOS_AIN5_gc) >> 2;
        uint16_t hue = adc_read(ADC_MUXPOS_AIN4_gc);
        struct led_color prev_stop;
        struct led_color next_stop;
        uint16_t r;
        uint16_t g;
        uint16_t b;
        unsigned stop;
        unsigned stop_off;
        unsigned i;
        uint16_t dither = 0;

        if (intensity == cur_intensity && (hue >> 2) == cur_hue) {
            _delay_ms(100);
            continue;
        }

        stop = (hue * (ARRAY_SIZE(led_stops) - 1)) / 1024;
        /* Offset between steps in 1/256th*/
        stop_off = ((hue * (ARRAY_SIZE(led_stops) - 1)) % 1024) >> 2;

        /* printf("%u %u %u.%u\n", intensity, hue, stop, stop_off); */

        prev_stop = led_stops[stop];
        next_stop = led_stops[stop + 1];

        r = ((prev_stop.r * (255 - stop_off)) + (next_stop.r * stop_off)) >> 8;
        g = ((prev_stop.g * (255 - stop_off)) + (next_stop.g * stop_off)) >> 8;
        b = ((prev_stop.b * (255 - stop_off)) + (next_stop.b * stop_off)) >> 8;

        r = (r * intensity) >> 6;
        g = (g * intensity) >> 6;
        b = (b * intensity) >> 6;

        r = log_lut[r];
        g = log_lut[g];
        b = log_lut[b];

        for (i = 0; i < NLEDS; i++) {
            dither = (dither + 1) & 0x3;

            leds[i].r = (r + dither) >> 2;
            leds[i].g = (g + dither) >> 2;
            leds[i].b = (b + dither) >> 2;
        }
        spi_send_leds();

        cur_hue = hue >> 2;
        cur_intensity = intensity;
    }

    return 0;
}
